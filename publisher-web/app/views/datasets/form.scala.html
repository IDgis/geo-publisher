@import nl.idgis.publisher.domain.web._
@import nl.idgis.publisher.domain.response._
@import nl.idgis.publisher.domain.service._

@(dataSources: Page[DataSource], 
	categories: Page[Category],
	sourceDatasets: Page[SourceDatasetStats],
	columns: List[Column], 
	datasetForm: Form[controllers.Datasets.DatasetForm])

@implicitField = @{ helper.FieldConstructor(helper.bootstrap.bootstrapFieldConstructor.f) }
@datasetId = @{datasetForm("id").value()}
@createDataset = @{datasetId == null || datasetId.isEmpty} 

@layout.application(
	title = "Nieuwe dataset toevoegen",
	jsMain = routes.Assets.at("js/datasets/form.js").url
) {
	<div class="page-content">
	@if(createDataset){
		<h1 class="page-header">Nieuwe dataset toevoegen</h1>
	}else{
		<h1 class="page-header">Dataset aanpassen</h1>
	}
		@if(datasetForm.hasErrors) {
			<div class="alert alert-danger">
				<h4>De dataset kan niet worden opgeslagen</h4>
				<p>Niet alle ingevulde waarden zijn geldig, de in onderstaande formulieren gemarkeerde fouten dienen eerst hersteld te worden.<p>
				@if(datasetForm.hasGlobalErrors) {
					<h5>Validatiefouten</h5>
					<ul>
						@for(error <- datasetForm.globalErrors) {
							<li>@error.message</li>
						}
					</ul>
				}
			</div>
		}
		
		<form @if(createDataset){action="@routes.Datasets.submitCreate()"}else{action="@routes.Datasets.submitEdit(datasetId)"} method="post" class="form-horizontal" role="form">
		
			<ul class="nav nav-tabs" role="tablist">
				<li class="active"><a href="#dataset-details" role="tab" data-toggle="tab">Algemene gegevens</a></li>
				<li id="tab-columns"@if(columns.isEmpty){ class="disabled"}><a href="#dataset-columns" role="tab"@if(!columns.isEmpty){ data-toggle="tab"}>@if(!datasetForm("columns").errors.isEmpty){ <span class="text-danger">Kolommen</span> }else{ Kolommen } <span class="badge">0</span></a></li>
				<li id="tab-filters"@if(columns.isEmpty){ class="disabled"}><a href="#dataset-filters" role="tab"@if(!columns.isEmpty){ data-toggle="tab"}>Filters <span class="badge">0</span></a></li>
			</ul>
			
			<div class="tab-content">
			
				<div class="tab-pane active" id="dataset-details">
					<div class="row">
						<div class="col-lg-8">
							@helper.inputText(
								datasetForm("name"), 
								'_label -> "Naam", 
								'id -> "input-name", 
								'class -> "form-control", 
								'placeholder -> "Naam ...", 
								'_help -> "De naam van de dataset"
							)
							
							@helper.select(
								datasetForm("dataSourceId"),
								helper.options(
									"" -> "Selecteer een gegevensbron ..."
								) ++
								dataSources.values.map (dataSource => { dataSource.id -> dataSource.name }),
								'_label -> "Gegegensbron",
								'id -> "input-datasource",
								'class -> "form-control",
								'_help -> "De gegevensbron die de gegevens voor deze dataset bevat"
							)
							
							@helper.select(
								datasetForm("categoryId"),
								helper.options(
									"" -> "Selecteer een categorie ..."
								) ++
								categories.values.map (category => { category.id -> category.name }),
								'_label -> "Categorie",
								'id -> "input-category",
								'class -> "form-control",
								'_help -> "De categorie van de dataset"
							)

							@helper.select(
								datasetForm("sourceDatasetId"),
								helper.options(
									"" -> "Selecteer een dataset ..."
								) ++
								sourceDatasets.values.map (sourceDataset => { sourceDataset.sourceDataset.id -> sourceDataset.sourceDataset.name }),
								if(sourceDatasets.values.isEmpty) { 'disabled -> "disabled" } else { Symbol("data-has-value") -> "true" },
								'_label -> "Dataset",
								'id -> "input-source-dataset",
								'class -> "form-control",
								'_help -> "De dataset uit de brongegevens waar deze dataset op is gebaseerd."
							)
							
							@if(createDataset){
								<div class="form-group has-feedback@if(!datasetForm("id").errors.isEmpty){ has-error}">
									<label class="control-label col-sm-3" for="input-id">Tabelnaam</label>
								    <div class="controls col-sm-9">
											<input type="text" class="form-control" id="input-id" placeholder="Tabelnaam ..." name="@datasetForm("id").name" value="@datasetForm("id").value">
											<span class="glyphicon glyphicon-refresh form-control-feedback rotating"></span>
											@if(!datasetForm("id").errors.isEmpty) {
										        <div class="help-block">
										        	<ul class="list-unstyled">
										        		@for(error <- datasetForm("id").errors) {
										        			<li>@Messages(error.message, error.arguments: _*)</li>
										        		}
										        	</ul>
										        </div>
										    }
									    <span class="help-block">De naam van de tabel die wordt gebruikt om deze dataset op te slaan</span>
									</div>
								</div>
							}else{
								<div class="form-group has-feedback">
									<label class="control-label col-sm-3" for="input-id-readonly">Tabelnaam</label>
								    <div class="controls col-sm-9">
										<input type="text" class="form-control" id="input-id-readonly" placeholder="Tabelnaam ..." name="@{datasetForm("id").name + "XX"}" value="@datasetForm("id").value" readonly>
										<input type="hidden" class="form-control" id="input-id" placeholder="Tabelnaam hidden..." name="@datasetForm("id").name" value="@datasetForm("id").value">
									    <span class="help-block">De naam van de tabel die wordt gebruikt om deze dataset op te slaan</span>
									</div>
								</div>
							}
						</div>						
					</div>
				</div>
				
				<div class="tab-pane" id="dataset-columns">
					<div class="row">
						<div class="col-lg-8">
							<div class="form-horizontal" role="form">
								<div class="form-group@if(!datasetForm("columns").errors.isEmpty){ has-error}">
									<label class="col-sm-3 control-label">Geselecteerde kolommen</label>
									<div class="col-sm-9">
										@if(!datasetForm("columns").errors.isEmpty) {
											<div class="alert alert-danger">
												Selecteer tenminste &eacute;&eacute;n kolom.
											</div>
										}
										<div id="column-list" class="list-group">
											@views.html.datasets.columns(columns, datasetForm)
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<div class="tab-pane" id="dataset-filters">
					<div class="row">
						<div class="col-lg-8">
							<textarea name="@datasetForm("filterConditions").name">@datasetForm("filterConditions").value</textarea>
							<div id="filter-editor">
							</div>
						</div>
					</div>
				</div>
			
			<div>
				<button type="submit" class="btn btn-primary">Opslaan</button>
				<a href="@routes.Datasets.list()" class="btn btn-default">Annuleren</a>
			</div>
		
		</form>
		 
	</div>
}