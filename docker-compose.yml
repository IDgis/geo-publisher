version: '2'

volumes:
  db_data:
  db_logs:
  service_raster:
  service_sslconf:
  geoserver_staging_data:
  geoserver_public_data:
  geoserver_secure_data: 
  
services:
  db:
    image: idgis/geopublisher_database
    restart: always
    ports:
      - "5432:5432"
    environment:
      - PG_USER=publisher
      - PG_PASSWORD=${PG_PASSWORD}
    volumes:
      - db_data:/var/lib/postgresql
      - db_logs:/var/log/postgresql
      
  db_init:
    build: publisher-database-init
    depends_on:
      - db
    environment:
      - PG_HOST=db
      - PG_PORT=5432
      - PG_DBNAME=publisher
      - PG_USER=publisher
      - PG_PASSWORD=${PG_PASSWORD}
      - DOMAIN_PREFIX=${DOMAIN_PREFIX}
      - DOMAIN_SUFFIX=${DOMAIN_SUFFIX}
  
  zookeeper:
    image: jplock/zookeeper
    restart: always
    
  service:
    image: idgis/geopublisher_service
    restart: always
    ports:
      - "4242:4242"
    environment:
      - PG_HOST=db
      - PG_PORT=5432
      - PG_DBNAME=publisher
      - PG_USER=publisher
      - PG_PASSWORD=${PG_PASSWORD}
      - GEOSERVER_USER=admin
      - GEOSERVER_PASSWORD=${GEOSERVER_PASSWORD}
      - AKKA_HOSTNAME=service
      - AKKA_LOGLEVEL=DEBUG
      - ZOOKEEPER_HOSTS=zookeeper
      - METADATA_URL_PREFIX=http://${DOMAIN_PREFIX}metadata${DOMAIN_SUFFIX}/metadata/dataset/
      - SSL_CONFIG=/etc/geo-publisher/ssl
      - RASTER_DIR=/var/lib/geo-publisher/raster
      - JAVA_OPTS=-Xmx256M
    volumes:
      - service_raster:/var/lib/geo-publisher/raster
      - service_sslconf:/etc/geo-publisher/ssl
      
  proxy:
    build: publisher-proxy
    restart: always
    ports:
      - "80:80"
      - "443:443"
    environment:
      - INTERNAL_ADDR_DOCKER=172.18.0.0/16
      - TRUSTED_ADDR_0=192.168.99.1/32
      - TRUSTED_HEADER=GeoPublisher-trusted
      - DOMAIN_PREFIX=${DOMAIN_PREFIX}
      - DOMAIN_SUFFIX=${DOMAIN_SUFFIX}
    
  web:
    image: idgis/geopublisher_web
    restart: always
    environment:
      - AKKA_HOSTNAME=web
      - SERVICE_HOST=service
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - GEOSERVER_DOMAIN=${DOMAIN_PREFIX}staging-services${DOMAIN_SUFFIX}
      - DATASET_METADATA_URL_PREFIX=http://${DOMAIN_PREFIX}metadata${DOMAIN_SUFFIX}/metadata/dataset/
      - SERVICE_METADATA_URL_PREFIX=http://${DOMAIN_PREFIX}metadata${DOMAIN_SUFFIX}/metadata/service/
      - JAVA_OPTS=-Xmx32M
    
  metadata:
    image: idgis/geopublisher_metadata
    restart: always
    environment:
      - PG_HOST=db
      - PG_PORT=5432
      - PG_DBNAME=publisher
      - PG_USER=publisher
      - PG_PASSWORD=${PG_PASSWORD}
      - TRUSTED_HEADER=GeoPublisher-trusted
      - METADATA_HOST=${DOMAIN_PREFIX}metadata${DOMAIN_SUFFIX}
      - JAVA_OPTS=-Xmx32M
    
  geoserver_staging:
    image: idgis/geopublisher_geoserver
    restart: always
    environment:
      - GEOSERVER_USER=admin
      - GEOSERVER_PASSWORD=${GEOSERVER_PASSWORD}
      - PG_HOST=db
      - PG_PORT=5432
      - PG_DBNAME=publisher
      - PG_USER=publisher
      - PG_PASSWORD=${PG_PASSWORD}
      - ZOOKEEPER_HOSTS=zookeeper
      - SERVICE_IDENTIFICATION=geoserver-staging
      - SERVICE_DOMAIN=${DOMAIN_PREFIX}staging-services${DOMAIN_SUFFIX}
      - JAVA_OPTS=-Xmx128M
    volumes:
      - geoserver_staging_data:/var/lib/geo-publisher/geoserver
    
  viewer_staging:
    image: idgis/geopublisher_viewer:1.2
    restart: always
    environment:
      - VIEWER_CONTEXT=/viewer
      - VIEWER_ENVIRONMENT_URL=http://${DOMAIN_PREFIX}staging-services${DOMAIN_SUFFIX}/geoserver/
      - VIEWER_USERNAME=admin
      - VIEWER_PASSWORD=geoserver
      - JAVA_OPTS=-Xmx32M
    links:
      - proxy:${DOMAIN_PREFIX}staging-services${DOMAIN_SUFFIX}

  geoserver_public:
    image: idgis/geopublisher_geoserver
    restart: always
    environment:
      - GEOSERVER_USER=admin
      - GEOSERVER_PASSWORD=${GEOSERVER_PASSWORD}
      - PG_HOST=db
      - PG_PORT=5432
      - PG_DBNAME=publisher
      - PG_USER=publisher
      - PG_PASSWORD=${PG_PASSWORD}
      - ZOOKEEPER_HOSTS=zookeeper
      - SERVICE_IDENTIFICATION=geoserver-public
      - SERVICE_DOMAIN=${DOMAIN_PREFIX}services${DOMAIN_SUFFIX}
      - JAVA_OPTS=-Xmx128M
    volumes:
      - geoserver_public_data:/var/lib/geo-publisher/geoserver
    
  viewer_public:
    image: idgis/geopublisher_viewer:1.2
    restart: always
    environment:
      - VIEWER_CONTEXT=/viewer
      - VIEWER_ENVIRONMENT_URL=http://${DOMAIN_PREFIX}services${DOMAIN_SUFFIX}/geoserver/
      - VIEWER_USERNAME=admin
      - VIEWER_PASSWORD=geoserver
      - JAVA_OPTS=-Xmx32M
    links:
      - proxy:${DOMAIN_PREFIX}services${DOMAIN_SUFFIX}
      
  geoserver_secure:
    image: idgis/geopublisher_geoserver
    restart: always
    environment:
      - GEOSERVER_USER=admin
      - GEOSERVER_PASSWORD=${GEOSERVER_PASSWORD}
      - PG_HOST=db
      - PG_PORT=5432
      - PG_DBNAME=publisher
      - PG_USER=publisher
      - PG_PASSWORD=${PG_PASSWORD}
      - ZOOKEEPER_HOSTS=zookeeper
      - SERVICE_IDENTIFICATION=geoserver-secure
      - SERVICE_DOMAIN=${DOMAIN_PREFIX}services${DOMAIN_SUFFIX}
      - JAVA_OPTS=-Xmx128M
    volumes:
      - geoserver_secure_data:/var/lib/geo-publisher/geoserver
    
  viewer_secure:
    image: idgis/geopublisher_viewer:1.2
    restart: always
    environment:
      - VIEWER_CONTEXT=/viewer
      - VIEWER_ENVIRONMENT_URL=http://${DOMAIN_PREFIX}secure-services${DOMAIN_SUFFIX}/geoserver/
      - VIEWER_USERNAME=admin
      - VIEWER_PASSWORD=geoserver
      - JAVA_OPTS=-Xmx32M
    links:
      - proxy:${DOMAIN_PREFIX}secure-services${DOMAIN_SUFFIX}